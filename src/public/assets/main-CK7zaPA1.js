import{createElementBlock as a,openBlock as r}from"vue";const h=(e,t)=>{const i=e.__vccOpts||e;for(const[s,n]of t)i[s]=n;return i},u={props:{annotations:{type:Array,required:!0},url:{type:String,required:!0}},computed:{selectedAnnotations(){return this.annotations.filter(e=>e.selected)},isDisabled(){return this.selectedAnnotations.length!==1},href(){return this.url+this.selectedAnnotations[0].id}}},b={class:"ananas-assistance-request"},f={key:0,class:"btn btn-default btn-block",title:"Please select a single annotation to make a new annotation assistance request",disabled:"disabled"},g=["href"];function p(e,t,i,s,n,l){return r(),a("div",b,[l.isDisabled?(r(),a("button",f,`
            Request annotation assistance
        `)):(r(),a("a",{key:1,href:l.href,class:"btn btn-default btn-block",title:"Make a new annotation assistance request for the selected annotation",target:"_blank"},`
            Request annotation assistance
        `,8,g))])}const m=h(u,[["render",p]]);let L=biigle.$require("annotations.components.annotationCanvas"),_=biigle.$require("api.annotations"),d=biigle.$require("annotations.components.annotationsTabPlugins"),o=biigle.$require("handleErrorResponse"),q=biigle.$require("annotations.stores.images"),$=biigle.$require("labelTrees.components.labelTrees"),k=biigle.$require("core.mixins.loader"),y=biigle.$require("resource"),A=biigle.$require("core.components.sidebar"),T=biigle.$require("core.components.sidebarTab"),I=biigle.$require("core.components.typeahead"),x=biigle.$require("api.users");d&&(d.assistanceRequest=m);const w={components:{labelTrees:$,typeahead:I},data(){return{users:[],selectedUser:null,labelTrees:[]}},computed:{flatLabels(){let e=[];return this.labelTrees.forEach(function(t){Array.prototype.push.apply(e,t.labels)}),e},selectedLabels(){return this.flatLabels.filter(e=>e.selected)},hasTooManySelectedLabels(){return this.selectedLabels.length>5},receiverId(){return this.selectedUser?this.selectedUser.id:""},receiverName(){return this.selectedUser?this.selectedUser.name:""}},methods:{close(){window.close()},loadUsers(){return x.query().then(this.usersLoaded,o)},usersLoaded:function(e){e.data.forEach(function(t){t.name=t.firstname+" "+t.lastname}),this.users=e.data},selectUser:function(e){this.selectedUser=e},clearSelectedUser(){this.selectedUser=null}},created(){let e=biigle.$require("ananas.oldLabels");if(Array.isArray(e)){let s={};e.forEach(function(n){s[n]=null}),this.flatLabels.forEach(function(n){s.hasOwnProperty(n.id)&&(n.selected=!0)})}let t=this.loadUsers(),i=biigle.$require("ananas.oldReceiverId");i&&t.then(()=>{for(let s=this.users.length-1;s>=0;s--)if(this.users[s].id==i){this.selectedUser=this.users[s];return}}),this.labelTrees=biigle.$require("ananas.labelTrees")}},v=y("api/v1/annotation-assistance-requests{/id}",{},{respond:{method:"PUT",url:"api/v1/annotation-assistance-requests{/token}"}}),c={mixins:[k],components:{sidebar:A,sidebarTab:T,annotationCanvas:L},data(){return{image:null,annotations:[],annotation:null}},methods:{setImageAndAnnotation(e){this.image=e,this.annotations.push(this.annotation)},focusAnnotation(){this.$refs.canvas.focusAnnotation(this.annotation,!0)}},created(){this.annotation=biigle.$require("ananas.annotation")},mounted(){this.startLoading(),q.fetchAndDrawImage(this.annotation.image_id).then(this.setImageAndAnnotation).then(this.focusAnnotation).catch(o).finally(this.finishLoading)}},U={mixins:[c],data(){return{pickedLabel:null,responseText:"",closed:!1,errors:[],showMinimap:!0,token:""}},computed:{hasPickedLabel(){return this.pickedLabel!==null},hasResponseText(){return!!this.responseText},hasDisabledControls(){return this.closed||this.loading},hasErrors(){return this.errors.length>0}},methods:{pickLabel:function(e){this.hasDisabledControls||(this.pickedLabel===e?this.pickedLabel=null:this.pickedLabel=e)},submit(){let e={};this.hasPickedLabel&&(e.response_label_id=this.pickedLabel),this.hasResponseText&&(e.response_text=this.responseText),this.startLoading(),v.respond({token:this.token},e).finally(this.clearErrors).then(this.handleSuccess,this.handleError).finally(this.finishLoading)},handleSuccess(){this.closed=!0},clearErrors:function(e){return this.errors=[],e},handleError:function(e){for(let t in e.body)e.body.hasOwnProperty(t)&&this.errors.push(e.body[t][0])},checkForMobile(){window.innerWidth<1e3?this.showMinimap=!1:this.showMinimap=!0}},created(){this.checkForMobile(),window.addEventListener("resize",this.checkForMobile),this.token=biigle.$require("ananas.token")}},E={mixins:[c],data(){return{existingLabels:[],userId:null,suggestedLabelId:null}},computed:{attachedSuggestedLabel(){let e=this.existingLabels;for(let t=e.length-1;t>=0;t--)if(e[t].label_id===this.suggestedLabelId&&e[t].user_id===this.userId)return!0;return!1}},methods:{attach(){this.startLoading(),_.attachLabel({id:this.annotation.id},{label_id:this.suggestedLabelId,confidence:1}).then(this.handleAttachSuccess,o).finally(this.finishLoading)},handleAttachSuccess(){this.existingLabels.push({label_id:this.suggestedLabelId,user_id:this.userId})}},created(){this.existingLabels=biigle.$require("ananas.labels"),this.userId=biigle.$require("ananas.userId"),this.suggestedLabelId=biigle.$require("ananas.suggestedLabelId")}};biigle.$mount("ananas-respond-container",U);biigle.$mount("ananas-show-container",E);biigle.$mount("create-ananas-form",w);
